class t{constructor(){this.strictStyling=!0}shimCssText(t,s,e="",o="",r=!1){const n=x(t);t=C(t);const c=[];if(r){const s=t=>{const s=`/*!@___${c.length}___*/`;return c.push({placeholder:s,comment:`/*!@${t.selector}*/`}),t.selector=s+t.selector,t};t=O(t,t=>"@"!==t.selector[0]?s(t):t.selector.startsWith("@media")||t.selector.startsWith("@supports")||t.selector.startsWith("@page")||t.selector.startsWith("@document")?(t.content=O(t.content,s),t):t)}const i=this._scopeCssText(t,s,e,o,r);return t=[i,...n].join("\n"),r&&c.forEach(({placeholder:s,comment:e})=>{t=t.replace(s,e)}),t}_scopeCssText(t,s,e,o,r){return t=this._insertPolyfillHostInCssText(t),t=this._convertColonHost(t),t=this._convertColonHostContext(t),t=this._convertColonSlotted(t,o),t=this._convertShadowDOMSelectors(t),s&&(t=this._scopeSelectors(t,s,e,o,r)),(t=(t=t.replace(/-shadowcsshost-no-combinator/g,`.${e}`)).replace(/>\s*\*\s+([^{, ]+)/gm," $1 ")).trim()}_convertColonHost(t){return this._convertColonRule(t,h,this._colonHostPartReplacer)}_convertColonSlotted(t,s){return t.replace(u,(...t)=>{if(t[2]){const e=t[2].trim();return"."+s+" > "+e+t[3]}return p+t[3]})}_convertColonHostContext(t){return this._convertColonRule(t,l,this._colonHostContextPartReplacer)}_convertColonRule(t,s,e){return t.replace(s,(...t)=>{if(t[2]){const s=t[2].split(","),o=[];for(let r=0;r<s.length;r++){const n=s[r].trim();if(!n)break;o.push(e(p,n,t[3]))}return o.join(",")}return p+t[3]})}_colonHostContextPartReplacer(t,s,e){return s.indexOf(r)>-1?this._colonHostPartReplacer(t,s,e):t+s+e+", "+s+" "+t+e}_colonHostPartReplacer(t,s,e){return t+s.replace(r,"")+e}_convertShadowDOMSelectors(t){return a.reduce((t,s)=>t.replace(s," "),t)}_scopeSelectors(t,s,o,r,n){return O(t,t=>{let c=t.selector,i=t.content;return"@"!==t.selector[0]?c=this._scopeSelector(t.selector,s,o,r,this.strictStyling):(t.selector.startsWith("@media")||t.selector.startsWith("@supports")||t.selector.startsWith("@page")||t.selector.startsWith("@document"))&&(i=this._scopeSelectors(t.content,s,o,r,n)),c=c.replace(/\s{2,}/g," ").trim(),new e(c,i)})}_scopeSelector(t,s,e,o,r){return t.split(",").map(t=>o&&t.indexOf("."+o)>-1?t.trim():this._selectorNeedsScoping(t,s)?r?this._applyStrictSelectorScope(t,s,e).trim():this._applySelectorScope(t,s,e).trim():t.trim()).join(", ")}_selectorNeedsScoping(t,s){return!this._makeScopeMatcher(s).test(t)}_makeScopeMatcher(t){return t=t.replace(/\[/g,"\\[").replace(/\]/g,"\\]"),new RegExp("^("+t+")"+g,"m")}_applySelectorScope(t,s,e){return this._applySimpleSelectorScope(t,s,e)}_applySimpleSelectorScope(t,s,e){if(m.lastIndex=0,m.test(t)){const o=this.strictStyling?`.${e}`:s;return t.replace(_,(t,s)=>s.replace(/([^:]*)(:*)(.*)/,(t,s,e,r)=>s+o+e+r)).replace(m,o+" ")}return s+" "+t}_applyStrictSelectorScope(t,e,o){const r="."+(e=e.replace(/\[is=([^\]]*)\]/g,(t,...s)=>s[0])),n=t=>{let s=t.trim();if(!s)return"";if(t.indexOf(p)>-1)s=this._applySimpleSelectorScope(t,e,o);else{const e=t.replace(m,"");if(e.length>0){const t=e.match(/([^:]*)(:*)(.*)/);t&&(s=t[1]+r+t[2]+t[3])}}return s},c=new s(t);let i,h="",l=0;const u=/( |>|\+|~(?!=))\s*/g;let _=!((t=c.content()).indexOf(p)>-1);for(;null!==(i=u.exec(t));){const s=i[1],e=t.slice(l,i.index).trim();h+=`${(_=_||e.indexOf(p)>-1)?n(e):e} ${s} `,l=u.lastIndex}const a=t.substring(l);return h+=(_=_||a.indexOf(p)>-1)?n(a):a,c.restore(h)}_insertPolyfillHostInCssText(t){return t.replace(S,c).replace(d,r).replace(w,n)}}class s{constructor(t){this.placeholders=[],this.index=0,t=t.replace(/(\[[^\]]*\])/g,(t,s)=>{const e=`__ph-${this.index}__`;return this.placeholders.push(s),this.index++,e}),this._content=t.replace(/(:nth-[-\w]+)(\([^)]+\))/g,(t,s,e)=>{const o=`__ph-${this.index}__`;return this.placeholders.push(e),this.index++,s+o})}restore(t){return t.replace(/__ph-(\d+)__/g,(t,s)=>this.placeholders[+s])}content(){return this._content}}class e{constructor(t,s){this.selector=t,this.content=s}}class o{constructor(t,s){this.escapedString=t,this.blocks=s}}const r="-shadowcsshost",n="-shadowcssslotted",c="-shadowcsscontext",i=")(?:\\(((?:\\([^)(]*\\)|[^)(]*)+?)\\))?([^,{]*)",h=new RegExp("("+r+i,"gim"),l=new RegExp("("+c+i,"gim"),u=new RegExp("("+n+i,"gim"),p=r+"-no-combinator",_=/-shadowcsshost-no-combinator([^\s]*)/,a=[/::shadow/g,/::content/g],g="([>\\s~+[.,{:][\\s\\S]*)?$",m=/-shadowcsshost/gim,d=/:host/gim,w=/::slotted/gim,S=/:host-context/gim,$=/\/\*\s*[\s\S]*?\*\//g,C=t=>t.replace($,""),f=/\/\*\s*#\s*source(Mapping)?URL=[\s\S]+?\*\//g,x=t=>t.match(f)||[],R=/(\s*)([^;\{\}]+?)(\s*)((?:{%BLOCK%}?\s*;?)|(?:\s*;))/g,L=/([{}])/g,O=(t,s)=>{const o=v(t);let r=0;return o.escapedString.replace(R,(...t)=>{const n=t[2];let c="",i=t[4],h="";i&&i.startsWith("{%BLOCK%")&&(c=o.blocks[r++],i=i.substring("%BLOCK%".length+1),h="{");const l=s(new e(n,c));return`${t[1]}${l.selector}${t[3]}${h}${l.content}${i}`})},v=t=>{const s=t.split(L),e=[],r=[];let n=0,c=[];for(let t=0;t<s.length;t++){const o=s[t];"}"===o&&n--,n>0?c.push(o):(c.length>0&&(r.push(c.join("")),e.push("%BLOCK%"),c=[]),e.push(o)),"{"===o&&n++}return c.length>0&&(r.push(c.join("")),e.push("%BLOCK%")),new o(e.join(""),r)},B=(s,e,o)=>(new t).shimCssText(s,e,e+"-h",e+"-s",o);export{t as ShadowCss,B as scopeCss};